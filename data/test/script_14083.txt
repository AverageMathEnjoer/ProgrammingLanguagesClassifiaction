b'package lyons.goods;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.util.LinkedList;\n\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport javax.servlet.http.HttpSession;\n\nimport com.sun.rowset.CachedRowSetImpl;\n\nimport lyons.db.DbClose;\nimport lyons.db.DbConn;\nimport lyons.entity.Goods;\nimport lyons.entity.Login;\n\npublic class BuyGoods extends HttpServlet\n{\n    \n    /**\n     * serialVersionUID\n     */\n    private static final long serialVersionUID = 1132L;\n\n    /**\n     * Constructor of the object.\n     */\n    public BuyGoods()\n    {\n        super();\n    }\n    \n    /**\n     * Destruction of the servlet. <br>\n     */\n    public void destroy()\n    {\n        super.destroy(); // Just puts "destroy" string in log\n        // Put your code here\n    }\n\n    public void doGet(HttpServletRequest request, HttpServletResponse response)\n        throws ServletException, IOException\n    {\n        doPost(request, response);\n    }\n    \n\n    public void doPost(HttpServletRequest request, HttpServletResponse response)\n        throws ServletException, IOException\n    {\n        \n        response.setContentType("text/html;charset=UTF-8");\n        request.setCharacterEncoding("UTF-8");\n        \n        //\xb4\xd3\xc4\xa3\xd0\xcd\xd6\xd0\xd6\xb1\xbd\xd3\xc4\xc3\xc8\xa1\xb9\xba\xce\xef\xb3\xb5\xd0\xc5\xcf\xa2\n        HttpSession session = request.getSession(true);\n        Login loginBean = (Login)session.getAttribute("loginBean");\n        String userName = "myNull";\n        userName = loginBean.getUsername();\n        LinkedList<String> car = null;\n        car = loginBean.getCar();\n        \n        //\xb9\xba\xce\xef\xb3\xb5\xca\xc7\xb7\xf1\xce\xaa\xbf\xd5\xa3\xac\xcf\xf2\xca\xfd\xbe\xdd\xbf\xe2\xd6\xd0\xc9\xbe\xb3\xfd\xd3\xeb\xb2\xe5\xc8\xeb\xca\xfd\xbe\xdd\n        if (car.size()!=0)\n        {\n            boolean falg = false;\n            Connection        conn  = null;\n            PreparedStatement pstmtCommodity = null;\n            PreparedStatement pstmtOrder = null;\n            \n            //\xbd\xab\xc9\xcc\xc6\xb7\xd0\xd0\xbc\xaf\xca\xfd\xbe\xdd\xb1\xe9\xc0\xfa\xb5\xbd\xca\xfd\xd7\xe9\xd6\xd0\n            for (int i = 0,m=car.size(); i < m; i++)\n            {\n                    String[] goods = null;\n                    conn = DbConn.getConn();\n                    goods = car.get(i).split(",");\n                    \n                    String sqlCommodity = null;\n                    String sqlOrder = null;\n                    sqlCommodity = "update Commodity set commodity_balance=? where commodity_number=?";\n                    sqlOrder = "insert into orderForm(username,commodity_name,commodity_price,sum) values(?,?,?,?)";\n    \n                        try\n                        {\n                            pstmtCommodity = conn.prepareStatement(sqlCommodity);\n                            pstmtOrder = conn.prepareStatement(sqlOrder);\n                            \n                            pstmtOrder.setString(1,userName);\n                            pstmtOrder.setInt(4,1);//\xc4\xac\xc8\xcf\xca\xfd\xc1\xbf\xce\xaa1\xa3\xac\xba\xf3\xc6\xda\xd4\xd9\xd4\xf6\xcc\xed\xd1\xa1\xd4\xf1\xb9\xba\xc2\xf2\xca\xfd\xc1\xbf\n                            \n                           /* 2-\xb0\xb2\xcc\xa4\xd4\xcb\xb6\xaf\xd0\xac-\xb8\xa3\xd6\xdd-120-800-002.jpg-1-\n                            10-ipad5-\xb1\xb1\xbe\xa9-5900-500-010.jpg-4-\n                            10-ipad5-\xb1\xb1\xbe\xa9-5900-500-010.jpg-4-*/\n                            \n                            //\xbd\xab\xc9\xcc\xc6\xb7\xb8\xf7\xd0\xd0\xbe\xdf\xcc\xe5\xca\xfd\xbe\xdd\xb1\xe9\xc0\xfa\xb5\xbd\xca\xfd\xd7\xe9\xd6\xd0,\xb2\xa2\xb6\xd4\xd3\xa6  \xd0\xde\xb8\xc4sqlCommodity\xa1\xa2\xd0\xb4\xc8\xebsqlOrder \xb5\xc4sql\xd3\xef\xbe\xe4\xd5\xbc\xce\xbb\xb7\xfb\n                            for (int j = 0,n=goods.length; j < n; j++)\n                            {\n                                switch (j)\n                                {\n                                    case 0:\n                                            String commodity_number = null;\n                                            commodity_number = goods[0];\n                                            pstmtCommodity.setString(2,commodity_number);\n                                        break;\n                                    case 1:\n                                            String commodity_name= null;\n                                            commodity_name = goods[1];\n                                            pstmtOrder.setString(2,commodity_name); \n                                        break;\n                                    case 2:\n                                        break;\n                                    case 3:\n                                            Double commodity_price = 0.00;\n                                            commodity_price = Double.parseDouble(goods[3]);\n                                            pstmtOrder.setDouble(3,commodity_price); \n                                        break;\n                                    case 4:\n                                            int commodity_balance = -1;\n                                            System.out.println(Integer.parseInt(goods[4]));\n                                            commodity_balance = Integer.parseInt(goods[4])-1;//\xc4\xbf\xc7\xb0\xca\xc7\xc4\xac\xc8\xcf\xc3\xbf\xb4\xce\xd0\xde\xb8\xc4\xd2\xbb\xb8\xf6\n                                            System.out.println(commodity_balance);\n                                            if (commodity_balance >= 0)\n                                            {\n                                                pstmtCommodity.setInt(1,commodity_balance);\n                                            }else \n                                                {\n                                                    String failNumber = "\xca\xfd\xbe\xdd\xbf\xe2\xd6\xd0\xc9\xcc\xc6\xb7\xb2\xbb\xd7\xe3";\n                                                    messShopping(request,response,failNumber);\n                                                }\n                                        break;\n                                    default:\n                                        System.out.println("defalut01");\n                                        break;\n                                }\n                                System.out.println("defalut02");\n                            }\n                                \n                            \n                                int rsCommodity = pstmtCommodity.executeUpdate();\n                                int rsOrder = pstmtOrder.executeUpdate();\n                                if (!(rsCommodity > 0 && rsOrder > 0))//\xb2\xe5\xc8\xeb\xca\xa7\xb0\xdc\n                                {\n                                    String failError = "\xd3\xeb\xca\xfd\xbe\xdd\xbf\xe2\xb6\xd4\xbd\xd3\xca\xb1\xb3\xf6\xcf\xd6\xd2\xec\xb3\xa3";\n                                    messShopping(request,response,failError);\n                                }else \n                                    {\n                                    System.out.println(i+"\xb4\xcb\xb4\xce\xd1\xad\xbb\xb7\xc9\xcc\xc6\xb7\xb9\xba\xc2\xf2\xb3\xc9\xb9\xa6");\n                                        falg = true;//\xb4\xcb\xb4\xce\xd1\xad\xbb\xb7\xc9\xcc\xc6\xb7\xb9\xba\xc2\xf2\xb3\xc9\xb9\xa6\n                                    }\n                                \n                        } catch (SQLException e)\n                        {\n        //                   \xb4\xcb\xb5\xd8\xd0\xe8\xd2\xaa\xbb\xd8\xb9\xf6\xca\xfd\xbe\xdd\xa3\xa1\xa3\xa1\xa3\xa1\xce\xb4\xca\xb5\xcf\xd6\n                           /*String backNews = "\xb9\xba\xce\xef\xca\xa7\xb0\xdc"+"<br>"+e;\n                           loginBean.setBackNews(backNews);//\xce\xaa\xc1\xcb\xca\xa1\xca\xc2\xa3\xac\xd6\xb1\xbd\xd3\xd3\xc3lyons.entity/Login.java \xc0\xe0\n*/                           System.out.println("\xc4\xaa\xc3\xfb\xd2\xec\xb3\xa3\xa3\xba"+e);\n                           \n                            PrintWriter out = response.getWriter();\n                            out.print(e+"<br>");\n                            out.print("\xb7\xb5\xbb\xd8"+"");\n                            out.print("<a href=/lyons.eaby/jsp/shoppingCar/lookShoppingCar.jsp>\xb9\xba\xce\xef\xb3\xb5</a>");\n                            return;\n                        }finally\n                        {\n                            DbClose.close(pstmtOrder,pstmtCommodity, conn);\n                        }\n                        \n                continue;\n             }\n                    \n                if (falg==true)\n                {\n                    //\xb8\xb6\xbf\xee\xb3\xc9\xb9\xa6\xa3\xac\xc7\xe5\xb3\xfd\xca\xfd\xbe\xdd\xc4\xa3\xd0\xcd\xd6\xd0\xb5\xc4\xca\xfd\xbe\xdd\n                    car.clear();\n                    /*//\xb4\xd3\xd0\xd0\xbc\xaf\xd6\xd0\xb8\xfc\xd0\xc2\xca\xfd\xbe\xdd\xbf\xe2\xd0\xc5\xcf\xa2\n                    request.getRequestDispatcher("/lyons.dao/GoodsDao?key=3").forward(request, response);*/\n                    \n                    updateInfo(request,response);\n                    \n                    String successBackNews = "\xc4\xfa\xd2\xd1\xbd\xab\xb9\xba\xce\xef\xb3\xb5\xd6\xd0\xb5\xc4\xc9\xcc\xc6\xb7\xc2\xf2\xbb\xd8\xbc\xd2\xc1\xcb";\n                    messShopping(request,response,successBackNews);\n                }\n            }\n        return;\n     \n    }\n    \n    /**\n     * \n     * \xb4\xd3\xca\xfd\xbe\xdd\xbf\xe2\xd6\xd0\xb8\xfc\xd0\xc2\xd0\xd0\xbc\xaf\xb6\xd4\xcf\xf3\n     * <\xb9\xa6\xc4\xdc\xcf\xea\xcf\xb8\xc3\xe8\xca\xf6>\n     * @param request\n     * @param response\n     * @throws IOException \n     */\n    private void updateInfo(HttpServletRequest request, HttpServletResponse response) throws IOException\n    {\n        CachedRowSetImpl rowSet = null;//\xd0\xd0\xbc\xaf\xb6\xd4\xcf\xf3\n        Connection conn = null;\n        PreparedStatement pstmt = null;\n        ResultSet rs = null;\n        Goods goods = null;\n        \n        HttpSession session = request.getSession(true);\n        goods = (Goods)session.getAttribute("goods");\n//      ArrayList<Goods> goodsList = new ArrayList<Goods>();\n        if (goods==null)\n        {\n            goods = new Goods();\n            session.setAttribute("goods", goods);\n        }\n        \n        conn = DbConn.getConn();\n        \n        String sqlListClear= "select * from commodity";\n        try\n        {\n            pstmt = conn.prepareStatement(sqlListClear);\n            rs = pstmt.executeQuery();\n            System.out.println("3\xd6\xb4\xd0\xd0\xca\xfd\xbe\xdd\xbf\xe2\xb2\xd9\xd7\xf7");\n            while (rs.next())\n            {\n                rowSet = new CachedRowSetImpl();\n                rowSet.populate(rs);\n                goods.setRowSet(rowSet);\n                System.out.println("3\xd2\xd1\xbe\xad\xb4\xd3\xca\xfd\xbe\xdd\xbf\xe2\xd6\xd0\xbb\xf1\xc8\xa1\xb5\xbd\xd6\xb5\xa3\xac\xb2\xa2\xc8\xfb\xbd\xf8\xd0\xd0\xbc\xaf");\n            }\n        } catch (SQLException e)\n        {\n            System.out.println("GoodsDao.java k=3 \xd4\xd9\xb4\xce\xb2\xe9\xd1\xaf\xca\xb1\xb3\xf6\xcf\xd6\xd2\xec\xb3\xa3\xa3\xba"+e);\n            PrintWriter out = response.getWriter();\n            out.print(e+"<br>");\n            out.print("\xb7\xb5\xbb\xd8"+"");\n            out.print("<a href=/lyons.eaby/jsp/shoppingCar/lookShoppingCar.jsp>\xb9\xba\xce\xef\xb3\xb5</a>");\n        }finally\n                {\n                    DbClose.allClose(pstmt, rs, conn);\n                }\n        \n    }\n\n    /**\n     * \n     * \xc9\xcc\xc6\xb7\xb9\xba\xc2\xf2\xb4\xa6\xc0\xed\xd0\xc5\xcf\xa2\n     * <\xb9\xa6\xc4\xdc\xcf\xea\xcf\xb8\xc3\xe8\xca\xf6>\n     * @param request\n     * @param response\n     * @param failNumber\n     */\n    public void messShopping(HttpServletRequest request, HttpServletResponse response, String mess)\n    {\n        try\n        {\n            PrintWriter out = response.getWriter();\n            out.print("<br><br><br>");\n            out.print("<center><font size=5 color=red><B>"+mess+"</B></font>&nbsp;");\n            out.print("<br><br><br>");\n            out.print("<a href=/lyons.eaby/jsp/browse/showGoods.jsp>\xb7\xb5\xbb\xd8\xbc\xcc\xd0\xf8\xb9\xba\xce\xef</a>");\n            out.print("&nbsp;or&nbsp;");\n            out.print("<a href=/lyons.eaby/lyons.dao/GoodsDao?key=3>\xb2\xe9\xbf\xb4\xb6\xa9\xb5\xa5</a></center>");\n        } catch (IOException e)\n        {\n            e.printStackTrace();\n        }\n        \n    }\n\n    public void init()\n        throws ServletException\n    {\n    }\n    \n}\n'