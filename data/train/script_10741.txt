b'\xef\xbb\xbfusing BaiduPanDownload.Util.FileTool;\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Net;\nusing System.Text;\nusing System.Threading;\n\nnamespace BaiduPanDownload.HttpTool.Download\n{\n    class DownloadThread\n    {\n        #region\n        public int ID { get; set; }\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe9\x93\xbe\xe6\x8e\xa5\n        /// </summary>\n        public string DownloadUrl { get; set; }\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe8\xb7\xaf\xe5\xbe\x84\n        /// </summary>\n        public string Path { get; set; }\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe5\x9d\x97\xe4\xbf\xa1\xe6\x81\xaf\n        /// </summary>\n        public DownloadBlock Block { get; set; }\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe4\xbf\xa1\xe6\x81\xaf\n        /// </summary>\n        public DownloadInfo Info { get; set; }\n        #endregion\n\n        #region \xe4\xba\x8b\xe4\xbb\xb6\n        public delegate void onThreadCompletedEvent();\n        public event onThreadCompletedEvent ThreadCompletedEvent;\n        #endregion\n\n        public DownloadThread()\n        {\n            WorkThread=new Thread(Start);\n            WorkThread.Start();\n        }\n        bool Stoped = false;\n        int num=0;\n        Thread WorkThread;\n        HttpWebRequest Request;\n        HttpWebResponse Response;\n        public void Start()\n        {\n            try\n            {\n                Thread.Sleep(1000);\n                if (Stoped)\n                {\n                    return;\n                }\n                if (Block.Completed)\n                {\n                    ThreadCompletedEvent?.Invoke();\n                    return;\n                }\n                Request = WebRequest.Create(DownloadUrl) as HttpWebRequest;\n                Request.UserAgent = "netdisk;5.3.4.5;PC;PC-Windows;5.1.2600;WindowsBaiduYunGuanJia";\n                Request.Referer = "http://pan.baidu.com/disk/home";\n                if (Info.Cookies != null)\n                {\n                    Cookie ck = new Cookie("BDUSS", Info.Cookies.BDUSS);\n                    ck.Domain = ".baidu.com";\n                    Request.CookieContainer = new CookieContainer();\n                    Request.CookieContainer.Add(ck);\n                    ck = new Cookie("pcsett", Info.Cookies.PCSETT);\n                    ck.Domain = ".baidu.com";\n                    Request.CookieContainer.Add(ck);\n                }\n                Request.Timeout = 1000;\n                Request.AddRange(Block.From,Block.To);\n                Response = Request.GetResponse() as HttpWebResponse;\n                if (!File.Exists(Path))\n                {\n                    LogTool.WriteLogInfo(typeof(DownloadThread), "\xe4\xb8\x8b\xe8\xbd\xbd\xe7\xba\xbf\xe7\xa8\x8b\xe5\x87\xba\xe7\x8e\xb0\xe9\x94\x99\xe8\xaf\xaf: \xe6\x95\xb0\xe6\x8d\xae\xe6\x96\x87\xe4\xbb\xb6\xe4\xb8\x8d\xe5\xad\x98\xe5\x9c\xa8");\n                    return;\n                }\n                using (Stream ResponseStream = Response.GetResponseStream())\n                {\n                    using (FileStream Stream=new FileStream(Path,FileMode.Open, FileAccess.ReadWrite, FileShare.ReadWrite))\n                    {\n                        Stream.Seek(Block.From, SeekOrigin.Begin);\n                        byte[] Array = new byte[4096];\n                        int i = ResponseStream.Read(Array, 0, Array.Length);\n                        while (true)\n                        {\n                            if(i<=0 && Block.From - 1 != Block.To && Block.From!=Block.To)\n                            {\n                                //\xe5\x8f\x91\xe9\x80\x81\xe7\xa9\xba\xe6\x95\xb0\xe6\x8d\xae,\xe6\x94\xbe\xe5\xbc\x83\xe8\xbf\x99\xe4\xb8\xaa\xe9\x93\xbe\xe6\x8e\xa5\xe9\x87\x8d\xe8\xaf\x95\n                                WorkThread = new Thread(Start);\n                                WorkThread.Start();\n                                return;\n                            }\n                            if (i <= 0)\n                            {\n                                break;\n                            }\n                            Stream.Write(Array, 0, i);\n                            Block.From += i;\n                            Block.CompletedLength += i;\n                            Info.CompletedLength += i;\n                            Info.DownloadBlockList[ID] = Block;\n                            i = ResponseStream.Read(Array, 0, Array.Length);\n                        }\n                        Block.Completed = true;\n                        ThreadCompletedEvent?.Invoke();\n                    }\n                }\n            }\n            catch(Exception ex)\n            {\n                if(ex is ThreadAbortException)\n                {\n                    return;\n                }\n                if(ex.Message.Contains("\xe7\xbb\x88\xe6\xad\xa2") || ex.Message.Contains("\xe5\x8f\x96\xe6\xb6\x88"))\n                {\n                    return;\n                }\n                if (num < 5)\n                {\n                    //num++;\n                    //LogTool.WriteLogError(typeof(DownloadThread),"\xe4\xb8\x8b\xe8\xbd\xbd\xe7\xba\xbf\xe7\xa8\x8b\xe5\x87\xba\xe7\x8e\xb0\xe9\x94\x99\xe8\xaf\xaf,\xe9\x87\x8d\xe8\xaf\x95\xe4\xb8\xad,\xe6\xac\xa1\xe6\x95\xb0: "+num,ex);\n                    WorkThread = new Thread(Start);\n                    WorkThread.Start();\n                    return;\n                }\n                LogTool.WriteLogError(typeof(DownloadThread), "\xe4\xb8\x8b\xe8\xbd\xbd\xe7\xba\xbf\xe7\xa8\x8b\xe5\x87\xba\xe7\x8e\xb0\xe9\x94\x99\xe8\xaf\xaf,\xe9\x87\x8d\xe8\xaf\x95\xe6\xac\xa1\xe6\x95\xb0\xe8\xb6\x85\xe8\xbf\x87\xe9\x98\x88\xe5\x80\xbc,\xe6\x94\xbe\xe5\xbc\x83\xe9\x87\x8d\xe8\xaf\x95", ex);\n            }\n        }\n        /// <summary>\n        /// \xe5\x81\x9c\xe6\xad\xa2\n        /// </summary>\n        public void Stop()\n        {\n            if (Block.Completed)\n            {\n                return;\n            }\n            Request?.Abort();\n            Response?.Close();\n            WorkThread.Abort();\n            Stoped = true;\n        }\n    }\n}\n'