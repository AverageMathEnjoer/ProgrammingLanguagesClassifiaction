b'library(rethinking)\n\nN <- 200  # number of grandparent-parent-child triads\nb_GP <- 1 # direct effect of G on P\nb_GC <- 0 # direct effect of G on C\nb_PC <- 1 # direct effect of P on C\nb_U <- 2 #direct effect of U on P and C\n\nset.seed(1)\nU <- 2*rbern( N , 0.5 ) - 1\nG <- rnorm( N )\nP <- rnorm( N , b_GP*G + b_U*U )\nC <- rnorm( N , b_PC*P + b_GC*G + b_U*U )\nd <- data.frame( C=C , P=P , G=G , U=U )\n\nm6.11 <- quap(\n    alist(\n        C ~ dnorm( mu , sigma ),\n        mu <- a + b_PC*P + b_GC*G,\n        a ~ dnorm( 0 , 1 ),\n        c(b_PC,b_GC) ~ dnorm( 0 , 1 ),\n        sigma ~ dexp( 1 )\n    ), data=d )\n\nplot(precis(m6.11,pars=c("b_GC","b_PC")))\n\npoints( b_GC , 1 , col=2 , pch=3 , lwd=4 )\npoints( b_PC , 2 , col=2 , pch=3 , lwd=4 )\n\n# blank2()\n# blank(bty="n")\nplot( C ~ G , pch=1 , col=ifelse( U > 0 , 2 , 1 ) , cex=exp(P/6) , xlab="Grandparent education" , ylab="child education" , lwd=3 )\n\n# highlight band of parental incomes\n# and draw regression line through them\n# band given in percentiles\n\nlibrary(animation)\n\n\nPband_seq <- seq( from=0 , to=1 , len=10 )\n\nani.record(reset = TRUE)\nfor ( i in 1:(length(Pband_seq)-1) ) {\n\nPband <- Pband_seq[i:(i+1)]\n\nb <- quantile( P , Pband )\nin_band <- ifelse( P>b[1] & P<b[2] , 1 , 0 )\nplot( C ~ G , col=ifelse( U > 0 , 2 , 1 ) , pch=ifelse( in_band , 16 , 1 ) , cex=0.5*in_band+1 , xlab="Grandparent education" , ylab="Child education" , lwd=2 )\nidx <- which( in_band==1 )\nabline( lm( C[idx] ~ G[idx] ) , lwd=5 , col="white" )\nabline( lm( C[idx] ~ G[idx] ) , lwd=3 )\ntext( -1 , max(C) , "good neighborhoods" , col="red" , cex=0.8 )\ntext( 1 , min(C) , "bad neighborhoods" , col="black" , cex=0.8 )\nmtext( concat("Parents between ", round(Pband[1]*100) ,"th and ", round(Pband[2]*100) ,"th centiles") )\n\nani.record()\n\n}\n\noopts = ani.options(interval = 0.5)\nani.replay()\n\n# ani.saveqz(dpi=150)\n# convert -alpha remove -background white -delay 20 -loop 0 frame*.png breen_collider.gif\n# convert -delay 100 breen_collider.gif breen_collider.gif\n'