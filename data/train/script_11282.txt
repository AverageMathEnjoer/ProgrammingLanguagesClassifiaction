b'package lyons.control;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.net.URLEncoder;\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\n\nimport javax.servlet.ServletException;\nimport javax.servlet.http.Cookie;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport javax.servlet.http.HttpSession;\n\n\nimport lyons.db.DbClose;\nimport lyons.db.DbConn;\nimport lyons.entity.Login;\n\n/**\n * \xb5\xc7\xc2\xbd\xb4\xa6\xc0\xed\n * @author Lyons(zhanglei)\n *\n */\n\npublic class HandleLogin extends HttpServlet \n{\n\tprivate static final long serialVersionUID = 1L; //\xc9\xe8\xd6\xc3\xd0\xf2\xc1\xd0\xba\xc5\n\tpublic HandleLogin()\n\t{\n\t\tsuper();\n\t}\n\tpublic void init() throws ServletException\n\t{\n\t}\n\tpublic void destroy()\n\t{\n\t\tsuper.destroy(); // Just puts "destroy" string in log\n\t}\n\tpublic void doGet(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException\n\t{\n\t\tdoPost(request, response);\n\t}\n\n\n\tpublic void doPost(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException\n\t{\n\n\t\tresponse.setContentType("text/html;charset=UTF-8");\n\t\trequest.setCharacterEncoding("UTF-8");//servlet\xd6\xd0\xd2\xb2\xd2\xaa\xb4\xcb\xcf\xee\xa3\xac\xb7\xf1\xd4\xf2\xc8\xa1\xd6\xb5\xc2\xd2\xc2\xeb\n\t\tString username = "";\n\t\tString userpass = "";\n\t\tString cookies  = "";\n\t\tusername = request.getParameter("username");\n\t\tuserpass = request.getParameter("userpass");\n\t\tcookies = request.getParameter("isCookie");\n\t\thandleCookies(request,response,username,userpass,cookies);//\xb4\xa6\xc0\xedcookies\xd0\xc5\xcf\xa2\n\t\t\n\t\tConnection conn = null;\n\t\tPreparedStatement pstmt = null;\n\t\tResultSet rs = null;\n\t\t\n\t\tconn = DbConn.getConn();\n\t\t\n\t\tString sql = "select * from vip where username=? and userpass=?";\n\t\ttry\n\t\t{\n\t\t\tpstmt = conn.prepareStatement(sql);\n\t\t\tpstmt.setString(1, username);\n\t\t\tpstmt.setString(2, userpass);\n\t\t\trs = pstmt.executeQuery();\n\t\t\tif (rs.next())\n\t\t\t{\n\t\t\t\t//\xb5\xc7\xc2\xbd\xb3\xc9\xb9\xa6\n\t\t\t\tsuccess(request,response,username);\n\t\t\t\trequest.getRequestDispatcher("/jsp/join/landing.jsp").forward(request, response);\n\t\t\t}else \n\t\t\t\t{\n\t\t\t\t\tString backNews = "\xd3\xc3\xbb\xa7\xc3\xfb\xbb\xf2\xd5\xdf\xc3\xdc\xc2\xeb\xb4\xed\xce\xf3";\n\t\t\t\t\tfail(request, response, backNews);\n\t\t\t\t}\n\t\t} catch (SQLException e)\n\t\t{\n\t\t\tString backNews = "\xb5\xc7\xc2\xbc\xca\xa7\xb0\xdc"+e;\n\t\t\tfail(request, response, backNews);\n\t\t}finally\n\t\t\t{\n\t\t\t\tDbClose.allClose(pstmt, rs, conn);\n\t\t\t}\n\t}\n\t\n\t/**\n\t * \xb4\xa6\xc0\xed\xd3\xc3\xbb\xa7cookies\xd0\xc5\xcf\xa2\n\t * @param request\n\t * @param response\n\t * @param username\n\t * @param userpass\n\t */\n\tpublic void handleCookies(HttpServletRequest request,HttpServletResponse response, \n\t\t\tString name,String pass,String isCookie)throws ServletException, IOException\n\t{\n\t\tif ("isCookie".equals(isCookie))//\xd3\xc3\xbb\xa7\xd1\xa1\xd4\xf1\xc1\xcb\xbc\xc7\xd7\xa1\xc3\xdc\xc2\xeb\n\t\t{\n\t\t\tString username = URLEncoder.encode(name,"UTF-8");//\xb1\xe0\xc2\xeb\xa3\xac\xbd\xe2\xbe\xf6cookie\xce\xde\xb7\xa8\xb1\xa3\xb4\xe6\xd7\xd6\xb7\xfb\xb4\xae\xb5\xc4\xce\xca\xcc\xe2\n\t\t\tString userpass = URLEncoder.encode(pass,"UTF-8");\n\t\t\t\n\t\t\tCookie nameCookie = new Cookie("username",username );//\xc9\xe8\xd6\xc3\xd3\xeb\xb5\xc7\xc2\xbd\xca\xb1\xb5\xc4name\xb6\xd4\xd3\xa6\xb5\xc4\xbc\xfc\xd6\xb5\xb6\xd4\n\t\t\tCookie passCookie = new Cookie("userpass",userpass );\n\t\t\t\n\t\t\tnameCookie.setPath("/");//\xc9\xe8\xd6\xc3\xb5\xc4cookie\xb5\xc4\xb4\xe6\xb4\xa2\xc2\xb7\xbe\xb6\xba\xdc\xd6\xd8\xd2\xaa\xa3\xac\xb2\xbb\xc8\xbb\xc8\xa1\xb2\xbb\xb5\xbd\xd6\xb5\n\t\t\tpassCookie.setPath("/");\n\t\t\tnameCookie.setMaxAge(864000); //\xc9\xe8\xd6\xc3\xc9\xfa\xc3\xfc\xc6\xda\xcf\xde\xca\xae\xcc\xec \xb5\xa5\xce\xbb\xc3\xeb\n\t\t\tpassCookie.setMaxAge(864000);\n\t\t\tresponse.addCookie(nameCookie); //\xb1\xa3\xb4\xe6\xd0\xc5\xcf\xa2\n\t\t\tresponse.addCookie(passCookie); \n\t\t}else \n\t\t\t{\n\t\t\t//\xd3\xc3\xbb\xa7\xce\xb4\xd1\xa1\xd4\xf1\xbc\xc7\xd7\xa1\xc3\xdc\xc2\xeb\xa3\xac\xc9\xbe\xb3\xfd\xe4\xaf\xc0\xc0\xc6\xf7\xd6\xd0\xbf\xc9\xc4\xdc\xb4\xe6\xd4\xda\xb5\xc4cookie\n\t\t\t\tCookie[] cookies = null;\n\t\t\t\tcookies = request.getCookies();\n\t\t\t\tif (cookies!=null&&cookies.length>0)\n\t\t\t\t{\n\t\t\t\t\tfor (Cookie c : cookies)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ("username".equals(c.getName())||"userpass".equals(c.getName()))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tc.setMaxAge(0);//\xc9\xe8\xd6\xc3cookie\xca\xa7\xd0\xa7\n\t\t\t\t\t\t\tc.setPath("/");//\xce\xf1\xb1\xd8\xc9\xe8\xd6\xc3\n\t\t\t\t\t\t\tresponse.addCookie(c);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t}\n\t\n\t/**\n\t * \xb5\xc7\xc2\xbd\xb3\xc9\xb9\xa6\xa3\xac\xb4\xa2\xb4\xe6\xd3\xc3\xbb\xa7\xd0\xc5\xcf\xa2\n\t */\n\tpublic void success(HttpServletRequest request,\n\t\t\tHttpServletResponse response, String username)\n\t{\n\t\tLogin loginBean = null;\n\t\tHttpSession session = request.getSession(true);\n\t\t\n\t\ttry\n\t\t{\n\t\t\tloginBean = (Login) session.getAttribute("loginBean");//\xbb\xf1\xc8\xa1session\xd6\xd0\xbf\xc9\xc4\xdc\xb4\xe6\xd4\xda\xb5\xc4loginBean\xb6\xd4\xcf\xf3\n\t\t\tif (loginBean == null)\n\t\t\t{\n\t\t\t\tloginBean = new Login();\n\t\t\t\tsession.setAttribute("loginBean", loginBean);//\xd7\xa2\xd2\xe2jsp\xbb\xf1\xc8\xa1\xca\xb1\xd0\xe8\xd2\xaa\xd3\xc3\xb5\xbd\xb8\xc3name\xb5\xc4\xca\xf4\xd0\xd4\xc3\xfb\xd7\xd6\n\t\t\t\tsession.setMaxInactiveInterval(600);//\xca\xae\xb7\xd6\xd6\xd3\xb5\xc4\xb4\xe6\xbb\xee\xc6\xda \xb5\xa5\xce\xbb\xa3\xba\xc3\xeb\n\t\t\t\tloginBean = (Login) session.getAttribute("loginBean");\n\t\t\t}\n\t\t\t\n\t\t\tString name = loginBean.getUsername();\n\t\t\tif (username.equals(name))\n\t\t\t{\n\t\t\t\tloginBean.setBackNews(username + "\xc4\xfa\xd2\xd1\xb5\xc7\xc2\xbd\xa3\xac\xce\xde\xd0\xe8\xd4\xd9\xb4\xce\xb5\xc7\xc2\xbc");\n\t\t\t\tloginBean.setUsername(username);\n\t\t\t} else\n\t\t\t\t{\n\t\t\t\t\tloginBean.setBackNews(username + "\xb5\xc7\xc2\xbd\xb3\xc9\xb9\xa6");\n\t\t\t\t\tloginBean.setUsername(username);\n\t\t\t\t}\n\t\t} catch (Exception e)\n\t\t{\n\t\t\tString backNews = "\xb5\xc7\xc2\xbc\xca\xa7\xb0\xdc"+e;\n\t\t\tfail(request, response, backNews);\n\t\t}\n\t\n\t}\n\t\n\t/**\n\t * \xb5\xc7\xc2\xbd\xca\xa7\xb0\xdc\n\t */\n\tpublic void fail(HttpServletRequest request,\n\t\t\tHttpServletResponse response,String backNews)\n\t{\n\t\ttry\n\t\t{\n\t\t\tPrintWriter out = response.getWriter();\n\t\t\tout.print(backNews+"<br>");\n\t\t\tout.print("\xb7\xb5\xbb\xd8"+"<a href=/lyons.eaby/jsp/join/login.jsp>\xb5\xc7\xc2\xbd\xbd\xe7\xc3\xe6</a>");\n\t\t} catch (IOException e)\n\t\t{\n\t\t\te.printStackTrace();\n\t\t}\n\t}\n}'