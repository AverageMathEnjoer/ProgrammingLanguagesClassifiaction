b'package com.codeest.geeknews.ui.zhihu.activity;\n\nimport android.content.Intent;\nimport android.support.design.widget.FloatingActionButton;\nimport android.support.v4.widget.NestedScrollView;\nimport android.support.v7.widget.Toolbar;\nimport android.transition.Transition;\nimport android.view.KeyEvent;\nimport android.widget.FrameLayout;\nimport android.widget.ImageView;\nimport android.widget.TextView;\n\nimport com.codeest.geeknews.R;\nimport com.codeest.geeknews.app.Constants;\nimport com.codeest.geeknews.base.RootActivity;\nimport com.codeest.geeknews.base.contract.zhihu.ZhihuDetailContract;\nimport com.codeest.geeknews.component.ImageLoader;\nimport com.codeest.geeknews.model.bean.DetailExtraBean;\nimport com.codeest.geeknews.model.bean.ZhihuDetailBean;\nimport com.codeest.geeknews.presenter.zhihu.ZhihuDetailPresenter;\nimport com.codeest.geeknews.util.HtmlUtil;\nimport com.codeest.geeknews.util.ShareUtil;\nimport com.codeest.geeknews.util.SystemUtil;\nimport com.tencent.smtt.sdk.WebSettings;\nimport com.tencent.smtt.sdk.WebView;\nimport com.tencent.smtt.sdk.WebViewClient;\n\nimport net.opacapp.multilinecollapsingtoolbar.CollapsingToolbarLayout;\n\nimport butterknife.BindView;\nimport butterknife.OnClick;\n\n/**\n * Created by codeest on 16/8/13.\n */\n\npublic class ZhihuDetailActivity extends RootActivity<ZhihuDetailPresenter> implements ZhihuDetailContract.View {\n\n    @BindView(R.id.detail_bar_image)\n    ImageView detailBarImage;\n    @BindView(R.id.detail_bar_copyright)\n    TextView detailBarCopyright;\n    @BindView(R.id.view_toolbar)\n    Toolbar viewToolbar;\n    @BindView(R.id.clp_toolbar)\n    CollapsingToolbarLayout clpToolbar;\n    @BindView(R.id.view_main)\n    WebView wvDetailContent;\n    @BindView(R.id.nsv_scroller)\n    NestedScrollView nsvScroller;\n    @BindView(R.id.tv_detail_bottom_like)\n    TextView tvDetailBottomLike;\n    @BindView(R.id.tv_detail_bottom_comment)\n    TextView tvDetailBottomComment;\n    @BindView(R.id.tv_detail_bottom_share)\n    TextView tvDetailBottomShare;\n    @BindView(R.id.ll_detail_bottom)\n    FrameLayout llDetailBottom;\n    @BindView(R.id.fab_like)\n    FloatingActionButton fabLike;\n\n    int id = 0;\n    int allNum = 0;\n    int shortNum = 0;\n    int longNum = 0;\n    String shareUrl;\n    String imgUrl;\n    boolean isBottomShow = true;\n    boolean isImageShow = false;\n    boolean isTransitionEnd = false;\n    boolean isNotTransition = false;\n\n    @Override\n    protected void initInject() {\n        getActivityComponent().inject(this);\n    }\n\n    @Override\n    protected int getLayout() {\n        return R.layout.activity_zhihu_detail;\n    }\n\n    @Override\n    protected void initEventAndData() {\n        super.initEventAndData();\n        setToolBar(viewToolbar,"");\n        Intent intent = getIntent();\n        id = intent.getExtras().getInt(Constants.IT_ZHIHU_DETAIL_ID);\n        isNotTransition = intent.getBooleanExtra("isNotTransition",false);\n        mPresenter.queryLikeData(id);\n        mPresenter.getDetailData(id);\n        mPresenter.getExtraData(id);\n        stateLoading();\n        WebSettings settings = wvDetailContent.getSettings();\n        if (mPresenter.getNoImageState()) {\n            settings.setBlockNetworkImage(true);\n        }\n        if (mPresenter.getAutoCacheState()) {\n            settings.setAppCacheEnabled(true);\n            settings.setDomStorageEnabled(true);\n            settings.setDatabaseEnabled(true);\n            if (SystemUtil.isNetworkConnected()) {\n                settings.setCacheMode(WebSettings.LOAD_DEFAULT);\n            } else {\n                settings.setCacheMode(WebSettings.LOAD_CACHE_ONLY);\n            }\n        }\n        settings.setJavaScriptEnabled(true);\n        settings.setLoadWithOverviewMode(true);\n        settings.setLayoutAlgorithm(WebSettings.LayoutAlgorithm.SINGLE_COLUMN);\n        settings.setSupportZoom(true);\n        wvDetailContent.setWebViewClient(new WebViewClient(){\n            @Override\n            public boolean shouldOverrideUrlLoading(WebView view, String url) {\n                view.loadUrl(url);\n                return true;\n            }\n        });\n        nsvScroller.setOnScrollChangeListener(new NestedScrollView.OnScrollChangeListener() {\n            @Override\n            public void onScrollChange(NestedScrollView v, int scrollX, int scrollY, int oldScrollX, int oldScrollY) {\n                if(scrollY - oldScrollY > 0 && isBottomShow) {  //\xe4\xb8\x8b\xe7\xa7\xbb\xe9\x9a\x90\xe8\x97\x8f\n                    isBottomShow = false;\n                    llDetailBottom.animate().translationY(llDetailBottom.getHeight());\n                } else if(scrollY - oldScrollY < 0 && !isBottomShow){    //\xe4\xb8\x8a\xe7\xa7\xbb\xe5\x87\xba\xe7\x8e\xb0\n                    isBottomShow = true;\n                    llDetailBottom.animate().translationY(0);\n                }\n            }\n        });\n        (getWindow().getSharedElementEnterTransition()).addListener(new Transition.TransitionListener() {\n            @Override\n            public void onTransitionStart(Transition transition) {\n            }\n            @Override\n            public void onTransitionEnd(Transition transition) {\n                /**\n                 * \xe6\xb5\x8b\xe8\xaf\x95\xe5\x8f\x91\xe7\x8e\xb0\xe9\x83\xa8\xe5\x88\x86\xe6\x89\x8b\xe6\x9c\xba(\xe5\xa6\x82\xe7\xba\xa2\xe7\xb1\xb3note2)\xe4\xb8\x8a\xe5\x8a\xa0\xe8\xbd\xbd\xe5\x9b\xbe\xe7\x89\x87\xe4\xbc\x9a\xe5\x8f\x98\xe5\xbd\xa2,\xe6\xb2\xa1\xe6\x9c\x89\xe8\xbe\xbe\xe5\x88\xb0centerCrop\xe6\x95\x88\xe6\x9e\x9c\n                 * \xe6\x9f\xa5\xe9\x98\x85\xe8\xb5\x84\xe6\x96\x99\xe5\x8f\x91\xe7\x8e\xb0Glide\xe9\x85\x8d\xe5\x90\x88SharedElementTransition\xe6\x98\xaf\xe6\x9c\x89\xe5\x9d\x91\xe7\x9a\x84,\xe9\x9c\x80\xe8\xa6\x81\xe5\x9c\xa8Transition\xe5\x8a\xa8\xe7\x94\xbb\xe7\xbb\x93\xe6\x9d\x9f\xe5\x90\x8e\xe5\x86\x8d\xe5\x8a\xa0\xe8\xbd\xbd\xe5\x9b\xbe\xe7\x89\x87\n                 * https://github.com/TWiStErRob/glide-support/blob/master/src/glide3/java/com/bumptech/glide/supportapp/github/_847_shared_transition/DetailFragment.java\n                 */\n                isTransitionEnd = true;\n                if (imgUrl != null) {\n                    isImageShow = true;\n                    ImageLoader.load(mContext, imgUrl, detailBarImage);\n                }\n            }\n            @Override\n            public void onTransitionCancel(Transition transition) {\n            }\n            @Override\n            public void onTransitionPause(Transition transition) {\n            }\n            @Override\n            public void onTransitionResume(Transition transition) {\n            }\n        });\n    }\n\n    @Override\n    public void showContent(ZhihuDetailBean zhihuDetailBean) {\n        stateMain();\n        imgUrl = zhihuDetailBean.getImage();\n        shareUrl = zhihuDetailBean.getShare_url();\n        if (isNotTransition) {\n            ImageLoader.load(mContext, zhihuDetailBean.getImage(), detailBarImage);\n        } else {\n            if (!isImageShow && isTransitionEnd) {\n                ImageLoader.load(mContext, zhihuDetailBean.getImage(), detailBarImage);\n            }\n        }\n        clpToolbar.setTitle(zhihuDetailBean.getTitle());\n        detailBarCopyright.setText(zhihuDetailBean.getImage_source());\n        String htmlData = HtmlUtil.createHtmlData(zhihuDetailBean.getBody(),zhihuDetailBean.getCss(),zhihuDetailBean.getJs());\n        wvDetailContent.loadData(htmlData, HtmlUtil.MIME_TYPE, HtmlUtil.ENCODING);\n    }\n\n    @Override\n    public void showExtraInfo(DetailExtraBean detailExtraBean) {\n        tvDetailBottomLike.setText(String.format("%d\xe4\xb8\xaa\xe8\xb5\x9e",detailExtraBean.getPopularity()));\n        tvDetailBottomComment.setText(String.format("%d\xe6\x9d\xa1\xe8\xaf\x84\xe8\xae\xba",detailExtraBean.getComments()));\n        allNum = detailExtraBean.getComments();\n        shortNum = detailExtraBean.getShort_comments();\n        longNum = detailExtraBean.getLong_comments();\n    }\n\n    @Override\n    public void setLikeButtonState(boolean isLiked) {\n        fabLike.setSelected(isLiked);\n    }\n\n    public boolean onKeyDown(int keyCode, KeyEvent event) {\n        if ((keyCode == KeyEvent.KEYCODE_BACK) && wvDetailContent.canGoBack()) {\n            wvDetailContent.goBack();\n            return true;\n        }\n        return super.onKeyDown(keyCode, event);\n    }\n\n    @OnClick(R.id.tv_detail_bottom_comment)\n    void gotoComment() {\n        Intent intent = getIntent();\n        intent.setClass(this,CommentActivity.class);\n        intent.putExtra(Constants.IT_ZHIHU_COMMENT_ID, id);\n        intent.putExtra(Constants.IT_ZHIHU_COMMENT_ALL_NUM, allNum);\n        intent.putExtra(Constants.IT_ZHIHU_COMMENT_SHORT_NUM, shortNum);\n        intent.putExtra(Constants.IT_ZHIHU_COMMENT_LONG_NUM, longNum);\n        startActivity(intent);\n    }\n\n    @OnClick(R.id.tv_detail_bottom_share)\n    void shareUrl() {\n        ShareUtil.shareText(mContext,shareUrl,"\xe5\x88\x86\xe4\xba\xab\xe4\xb8\x80\xe7\xaf\x87\xe6\x96\x87\xe7\xab\xa0");\n    }\n\n    @OnClick(R.id.fab_like)\n    void likeArticle() {\n        if (fabLike.isSelected()) {\n            fabLike.setSelected(false);\n            mPresenter.deleteLikeData();\n        } else {\n            fabLike.setSelected(true);\n            mPresenter.insertLikeData();\n        }\n    }\n\n    @Override\n    public void onBackPressedSupport() {\n        if (getSupportFragmentManager().getBackStackEntryCount() > 1) {\n            pop();\n        } else {\n            finishAfterTransition();\n        }\n    }\n}\n'