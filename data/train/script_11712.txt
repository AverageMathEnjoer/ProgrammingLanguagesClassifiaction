b'context("unmix")\ntest_that("unmixing samples works", {\n\n  set.seed(1)\n  n <- 100\n  a <- runif(n)\n  b <- runif(n)\n  c <- runif(n)\n  counts <- matrix(nrow=n, ncol=8)\n  disp <- 0.01\n\n  counts[,1] <- rnbinom(n, mu=1e4 * a, size=1/disp)\n  counts[,2] <- rnbinom(n, mu=1e4 * b, size=1/disp)\n  counts[,3] <- rnbinom(n, mu=1e4 * c, size=1/disp)\n  counts[,4] <- rnbinom(n, mu=1e4 * (.75*a + .25*b), size=1/disp)\n  counts[,5] <- rnbinom(n, mu=1e4 * (.5*a + .5*b), size=1/disp)\n  counts[,6] <- rnbinom(n, mu=1e4 * (.25*a + .75*b), size=1/disp)\n  counts[,7] <- rnbinom(n, mu=1e4 * (.33*a + .33*b + .33*c), size=1/disp)\n  counts[,8] <- rnbinom(n, mu=1e4 * (.25*a + .25*b + .5*c), size=1/disp)\n  coldata <- data.frame(a=c(1,0,0,.75,.5,.25,.33,.25),\n                        b=c(0,1,0,.25,.5,.75,.33,.25),\n                        c=c(0,0,1,  0,  0, 0,.33,.5))\n\n  dds <- DESeqDataSetFromMatrix(counts, coldata, ~1)\n  dds <- estimateSizeFactors(dds)\n  dds <- estimateDispersions(dds, fitType="mean")\n  vsd <- varianceStabilizingTransformation(dds, blind=FALSE)\n  #library(ggplot2)\n  #plotPCA(vsd, intgroup=c("a","b","c")) + geom_point(size=5)\n\n  pure <- matrix(rnbinom(3*n,mu=1e4*c(a,b,c),size=1/disp),ncol=3)\n  colnames(pure) <- c("a","b","c")\n\n  colnames(counts) <- paste0("sample",seq_len(ncol(counts)))\n  \n  alpha <- attr(dispersionFunction(dds),"mean")\n\n  mix <- unmix(counts, pure=pure, alpha=alpha, quiet=TRUE)\n\n  max(abs(dds$a - mix[,1]))\n  max(abs(dds$b - mix[,2]))\n  max(abs(dds$c - mix[,3]))\n  \n  expect_lt(max(abs(dds$a - mix[,1])), .1)\n  expect_lt(max(abs(dds$b - mix[,2])), .1)\n  expect_lt(max(abs(dds$c - mix[,3])), .1)\n\n  # test the shifted log (designed for TPMs)\n  mix2 <- unmix(counts, pure=pure, shift=0.5, quiet=TRUE)\n\n  # test expanded output\n  mix3 <- unmix(counts, pure=pure, alpha=alpha, format="list", quiet=TRUE)\n\n  # test warning\n  pure <- cbind(pure[,1:3], d=(pure[,3] + rpois(n, 10)))\n  expect_warning(unmix(counts, pure=pure, alpha=alpha, quiet=TRUE), "highly correlated")\n  \n})\n'