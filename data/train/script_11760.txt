b'{-# LANGUAGE RankNTypes        #-}\n{-# LANGUAGE FlexibleInstances #-}\n\nimport           Control.Applicative\nimport           Control.Concurrent\nimport           Control.Monad\nimport           Control.Monad.Identity\nimport           Control.Monad.Trans.Reader\nimport           Control.Monad.Trans.Class\nimport           Control.Monad.Trans.MSF\nimport           Data.Maybe\nimport           Data.MonadicStreamFunction hiding (reactimate, switch, trace)\nimport qualified Data.MonadicStreamFunction as MSF\nimport           Debug.Trace\nimport           FRP.BearRiver\nimport           Graphics.UI.SDL            as SDL\nimport           Graphics.UI.SDL.Primitives as SDL\n\ntype Stream m b = SF m () b\ntype Signal m a = Stream m a\n\nballInCirclesAroundMouse :: GameMonad m => Signal m (Int, Int)\nballInCirclesAroundMouse =\n  addPair <$> mousePos <*> ballInCircles\n\n-- Mouse position\nmousePos :: GameMonad m => Signal m (Int, Int)\nmousePos = arrM (\\() -> lift getMousePos)\n\n-- Ball going around in circles\nballInCircles :: (Functor m, Monad m) => Signal m (Int, Int)\nballInCircles =\n  (\\(x,y) -> (round x, round y)) <$> ballInCirclesD\n\nballInCirclesD :: (Functor m, Monad m) => Signal m (Double, Double)\nballInCirclesD =\n  (\\x -> (rad * cos x, rad * sin x)) <$> (/2) <$> time\n  where rad = 45 -- radius in pixels\n\n-- Auxiliary\naddPair :: Num a => (a,a) -> (a,a) -> (a,a)\naddPair (x1,x2) (y1,y2) = (x1+y1, x2+y2)\n\nmain = do\n   SDL.init [InitEverything]\n   SDL.setVideoMode 800 600 32 [SWSurface]\n   reactimate\' ballInCirclesAroundMouse\n\n-- Output\nrender (px,py) = do\n  print (px, py)\n  screen <- SDL.getVideoSurface\n\n  white <- SDL.mapRGB (SDL.surfaceGetPixelFormat screen) 0xFF 0xFF 0xFF\n  SDL.fillRect screen Nothing white\n\n  SDL.filledCircle screen (fromIntegral px) (fromIntegral py) 30 (Pixel 0xFF0000FF)\n\n  SDL.flip screen\n\n  threadDelay 1000\n\nreactimate\' :: Signal Identity (Int, Int) -> IO ()\nreactimate\' sf =\n  MSF.reactimate $ sense >>> morphS (return.runIdentity) sfIO >>> actuate\n where sfIO    = runReaderS sf\n       sense   = arr (const (0.2, ()))\n       actuate = arrM render\n\nrunOnce :: (Monad m, Applicative m) => MSF m a b -> a -> m b\nrunOnce msf a = head <$> embed msf [a]\n\nrunGame :: IO ()\nrunGame = do\n  SDL.init [InitEverything]\n  SDL.setVideoMode 800 600 32 [SWSurface]\n  MSF.reactimate $ sense >>> sfIO >>> actuate\n where sfIO    = runReaderS ballInCirclesAroundMouse\n       sense   = arr (const (0.2, ()))\n       actuate = arrM render\n\nrunDebug :: StateT [PureGameEnv] IO ()\nrunDebug =\n  MSF.reactimate $ sense >>> sfIO >>> actuate\n where sfIO    = runReaderS ballInCirclesAroundMouse\n       sense   = arr (const (0.2, ()))\n       actuate = arrM (lift . print)\n\nclass (Functor m, Applicative m, Monad m) => GameMonad m where\n  getMousePos :: m (Int, Int)\n\ninstance GameMonad IO where\n  getMousePos = do\n    pumpEvents\n    (x,y,btns) <- SDL.getMouseState\n    putStrLn $ "Mouse position: " ++ show (x,y)\n    return (fromIntegral x, fromIntegral y)\n\ninstance GameMonad Identity where\n  getMousePos = return (400, 300)\n\ninstance (Functor m, Applicative m, Monad m) => GameMonad (ReaderT PureGameEnv m) where\n  getMousePos = pureMousePos <$> ask\n\ndata PureGameEnv = PureGameEnv { pureMousePos :: (Int, Int)}\n\ninstance (Functor m, Monad m) => GameMonad (StateT [PureGameEnv] m) where\n  getMousePos = StateT $ \\ls -> case ls of\n    []     -> error "End of saved input trace"\n    (p:ps) -> return (pureMousePos p, ps)\n\ntestPureEnv :: [ PureGameEnv ]\ntestPureEnv = map PureGameEnv\n  [ (418,331)\n  , (496,327)\n  , (613,253)\n  , (616,214)\n  , (500,79)\n  , (463,59)\n  , (454,54)\n  , (437,51)\n  , (350,63)\n  , (281,82)\n  ]\n\nsampleTrace =\n [ ((347,128),(266,140))\n , ((310,149),(252,170))\n , ((295,183),(252,219))\n , ((293,237),(252,285))\n , ((291,307),(252,328))\n , ((289,353),(297,369))\n , ((331,398),(584,372))\n , ((615,404),(737,350))\n , ((765,385),(737,350))\n , ((761,388),(737,350))\n ]\n\n-- Mouse position: (418,331)\n-- (463,335)\n-- Mouse position: (496,327)\n-- (540,336)\n-- Mouse position: (613,253)\n-- (656,266)\n-- Mouse position: (616,214)\n-- (657,232)\n-- Mouse position: (500,79)\n-- (539,101)\n-- Mouse position: (463,59)\n-- (500,84)\n-- Mouse position: (454,54)\n-- (488,83)\n-- Mouse position: (437,51)\n-- (468,83)\n-- Mouse position: (350,63)\n-- (378,98)\n-- Mouse position: (281,82)\n-- (305,120)\n--\n-- (463,335)\n-- (540,336)\n-- (656,266)\n-- (657,232)\n-- (539,101)\n-- (500,84)\n-- (488,83)\n-- (468,83)\n-- (378,98)\n-- (305,120)\n'