b'# cherry blossom cover plot\n\nlibrary(rethinking)\nlibrary(animation)\n\ndata(cherry_blossoms)\nd <- cherry_blossoms\n\nlibrary(splines)\nnum_knots <- 30\n\n# spline on blossom doy\nd3 <- d[ complete.cases(d$doy) , ] # complete cases on doy\n\n# subsample\n\nblossom_col <- sapply( d3$doy , function(y) hsv(1, rbeta2(1, inv_logit(logit(0.1)+0.02*y) ,10) ,1,0.8) )\n\nblank2(w=2,h=0.8)\n\n#set.seed(1375)\nani.record(reset = TRUE)  # clear history before recording\nnf <- 1\nntwinkle <- 50\nhead_frames <- 30\ntwinkle_frames <- 0\ntot_frames <- head_frames + twinkle_frames\nynorm <- normalize(d3$year)\nyseq <- seq( from=0 , to=1 , length.out=twinkle_frames )\ndo_save <- TRUE\n\nknothist <- rep(30,tot_frames)\nknothist[c(10,20,28)] <- 50\nknothist[25] <- 10\n\nfor ( i in 1:tot_frames ) {\n\n    print(concat("frame ",i))\n\n    if ( i > head_frames ) {\n        # weight twinkle set by year\n        pvec <- 1 - exp( -10*(ynorm - yseq[i-head_frames])^2 )\n        idx <- sample( 1:nrow(d3) , size=nrow(d3)-ntwinkle , prob=pvec )\n    } else {\n        # stable head still so all points\n        idx <- 1:nrow(d3)\n    }\n\n    dd <- d3[ idx , ]\n    dd <- dd[ order(dd$year) , ]\n\n    num_knots <- knothist[i]\n    knot_list <- seq( from=min(dd$year) , to=max(dd$year) , length.out=num_knots )\n    B3 <- t(bs(dd$year, knots=knot_list , degree=3, intercept = FALSE))\n\n    m2 <- quap(\n        alist(\n            Y ~ dnorm( mu , exp(log_sigma) ) ,\n            mu <- a0 + as.vector( a %*% B ),\n            a0 ~ dnorm(100,10),\n            a ~ dnorm(0,10),\n            log_sigma ~ dnorm(0,0.5)\n        ),\n        data=list( Y=dd$doy , B=B3 ) , start=list(a=rep(0,nrow(B3))) )\n\n    # PLOT\n\n    par( mfrow=c(1,1) , mgp = c(1.25, 0.25, 0), mar = c(0.75, 2.5, 0.75, 0.75) + 0.1, \n            tck = -0.02, cex.axis = 0.8 )\n\n    xcex <- 1.2\n    xpch <- 16\n    xcol1 <- col.alpha(rangi2,0.3)\n    col_spline <- col.alpha("black",0.4)\n    xlims <- c(850,2000)\n\n    y <- d3$doy\n    y <- y - min(y)\n    y <- y/max(y)\n\n    #blossom_col <- sapply( d3$doy , function(y) hsv(1, rbeta2(1, inv_logit(logit(0.1)+0.02*y) ,10) ,1,0.8) )\n\n    plot( NULL , cex=xcex , ylab="" , xlim=xlims , bty="n" , axes=FALSE , xlab="" , ylim=range(d3$doy) )\n    l <- link( m2 )\n    li <- apply(l,2,PI,0.9)\n    points( dd$year , dd$doy , col=blossom_col ,  pch=8  , cex=xcex , lwd=2 )\n\n    shade( li , dd$year , col=grau(0.3) )\n\n    ani.record()  # record the current frame\n    if ( do_save==TRUE ) {\n        quartz.save( concat("frames/frame_",1000+nf,".png") , type = "png", device = dev.cur(), dpi = 200 )\n        nf <- nf + 1\n    }\n\n}\n\noopts = ani.options(interval = 0.1)\nani.replay()\n\n# convert -alpha remove -background white -delay 10 -loop 0 frame*.png title_twinkle.gif\n'