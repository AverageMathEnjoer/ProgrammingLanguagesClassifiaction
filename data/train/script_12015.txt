b'\xef\xbb\xbfusing BaiduPanDownload.Util.FileTool;\nusing Newtonsoft.Json;\nusing Newtonsoft.Json.Linq;\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Net;\nusing System.Text;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing System.Windows.Forms;\n\nnamespace BaiduPanDownload.HttpTool.Download\n{\n    class HttpDownload\n    {\n        #region \xe5\x8f\x82\xe6\x95\xb0\n        /// <summary>\n        /// \xe4\xbb\xbb\xe5\x8a\xa1ID\n        /// </summary>\n        public int ID { get; set; }\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe9\x93\xbe\xe6\x8e\xa5\n        /// </summary>\n        public string Url { get; set; }\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe8\xb7\xaf\xe5\xbe\x84\n        /// </summary>\n        public string DownloadPath { get; set; }\n        /// <summary>\n        /// \xe7\xba\xbf\xe7\xa8\x8b\xe6\x95\xb0\n        /// </summary>\n        public int ThreadNum { get; set; }\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe9\x80\x9f\xe5\xba\xa6\n        /// </summary>\n        public long Speed { get; private set; } = 0L;\n        /// <summary>\n        /// \xe4\xb8\x8b\xe8\xbd\xbd\xe8\xbf\x9b\xe5\xba\xa6\n        /// </summary>\n        public float Percentage { get; private set; } = 0F;\n        /// <summary>\n        /// \xe6\x98\xaf\xe5\x90\xa6\xe4\xb8\x8b\xe8\xbd\xbd\xe4\xb8\xad\n        /// </summary>\n        public bool Downloading { get; private set; }\n        /// <summary>\n        /// \xe6\x98\xaf\xe5\x90\xa6\xe5\xae\x8c\xe6\x88\x90\n        /// </summary>\n        public bool Completed { get; private set; }\n        /// <summary>\n        /// Cookies\n        /// </summary>\n        public CookiesData Cookies { get; set; }\n        /// <summary>\n        /// \xe6\x98\xaf\xe5\x90\xa6\xe7\xbb\x88\xe6\xad\xa2\n        /// </summary>\n        public bool Stoped { get; private set; }\n        #endregion\n\n        DownloadThread[] Threads;\n        DownloadInfo Info;\n        /// <summary>\n        /// \xe5\xbc\x80\xe5\xa7\x8b\xe4\xb8\x8b\xe8\xbd\xbd\n        /// </summary>\n        public void Start()\n        {\n            try\n            {\n                Downloading = true;\n                Stoped = false;\n                HttpWebRequest Request = WebRequest.Create(Url) as HttpWebRequest;\n                Request.Referer= "http://pan.baidu.com/disk/home";\n                //\xe7\xac\xac\xe4\xb8\x80\xe6\xac\xa1\xe4\xb8\x8b\xe8\xbd\xbd\xe8\xae\xbe\xe7\xbd\xaeCookies\n                if (Cookies != null)\n                {\n                    Cookie ck = new Cookie("BDUSS", Cookies.BDUSS);\n                    ck.Domain = ".baidu.com";\n                    Request.CookieContainer = new CookieContainer();\n                    Request.CookieContainer.Add(ck);\n                    ck = new Cookie("pcsett", Cookies.PCSETT);\n                    ck.Domain = ".baidu.com";\n                    Request.CookieContainer.Add(ck);\n                }\n                //\xe6\x94\xb9\xe4\xb8\xba\xe8\x8e\xb7\xe5\x8f\x96Response\xe4\xb9\x8b\xe5\x89\x8d\xe8\xaf\xbb\xe5\x85\xa5\xe6\x95\xb0\xe6\x8d\xae\xe6\x96\x87\xe4\xbb\xb6,\xe8\xbf\x99\xe6\xa0\xb7\xe5\xb0\xb1\xe8\x83\xbd\xe8\xaf\xbb\xe5\x8f\x96\xe5\x88\xb0Cookies\xe4\xba\x86\n                if(File.Exists(DownloadPath + ".dcj"))\n                {\n                    Info = JsonConvert.DeserializeObject<DownloadInfo>(File.ReadAllText(DownloadPath + ".dcj"));\n                    if (Info.Cookies != null)\n                    {\n                        Cookie ck = new Cookie("BDUSS", Info.Cookies.BDUSS);\n                        ck.Domain = ".baidu.com";\n                        Request.CookieContainer = new CookieContainer();\n                        Request.CookieContainer.Add(ck);\n                        ck = new Cookie("pcsett", Info.Cookies.PCSETT);\n                        ck.Domain = ".baidu.com";\n                        Request.CookieContainer.Add(ck);\n                    }\n                }\n                HttpWebResponse Response = Request.GetResponse() as HttpWebResponse;\n                if (!File.Exists(DownloadPath + ".dcj"))\n                {\n                    Info = new DownloadInfo\n                    {\n                        ContentLength=Response.ContentLength,\n                        BlockLength=Response.ContentLength/ThreadNum,\n                        DownloadUrl = Url,\n                        Cookies=Cookies\n                    };\n                    Info.init(DownloadPath + ".dcj");\n                }\n                if (Info.Completed)\n                {\n                    Downloading = false;\n                    Completed = true;\n                    Percentage = 100F;\n                    return;\n                }\n                if (!File.Exists(DownloadPath))\n                {\n                    LogTool.WriteLogDebug(typeof(HttpDownload),"\xe6\xad\xa3\xe5\x9c\xa8\xe5\x88\x9b\xe5\xbb\xba\xe6\x96\x87\xe4\xbb\xb6: "+DownloadPath);\n                    FileStream Stream = new FileStream(DownloadPath, FileMode.CreateNew);\n                    Stream.SetLength(Response.ContentLength);\n                    Stream.Close();\n                }\n                Threads = new DownloadThread[Info.DownloadBlockList.Count];\n                for(int i = 0; i < Info.DownloadBlockList.Count; i++)\n                {\n                    DownloadBlock Block= JsonConvert.DeserializeObject<DownloadBlock>(Info.DownloadBlockList[i].ToString());\n                    Threads[i]=new DownloadThread\n                    {\n                        ID = i,\n                        DownloadUrl = Url,\n                        Path = DownloadPath,\n                        Block = Block,\n                        Info = Info\n                    };\n                    Threads[i].ThreadCompletedEvent += HttpDownload_ThreadCompletedEvent;\n                }\n                new Thread(a).Start();\n            }\n            catch(Exception ex)\n            {\n                Downloading = false;\n                Stoped = true;\n                LogTool.WriteLogError(typeof(HttpDownload), "\xe5\x88\x9b\xe5\xbb\xba\xe4\xb8\x8b\xe8\xbd\xbd\xe4\xbb\xbb\xe5\x8a\xa1\xe5\x87\xba\xe7\x8e\xb0\xe9\x94\x99\xe8\xaf\xaf", ex);\n            }\n        }\n\n        public void CreateDataFile()\n        {\n            try\n            {\n                HttpWebRequest Request = WebRequest.Create(Url) as HttpWebRequest;\n                Request.Referer = "http://pan.baidu.com/disk/home";\n                if (Cookies != null)\n                {\n                    Cookie ck = new Cookie("BDUSS", Cookies.BDUSS);\n                    ck.Domain = ".baidu.com";\n                    Request.CookieContainer = new CookieContainer();\n                    Request.CookieContainer.Add(ck);\n                    ck = new Cookie("pcsett", Cookies.PCSETT);\n                    ck.Domain = ".baidu.com";\n                    Request.CookieContainer.Add(ck);\n                }\n                HttpWebResponse Response = Request.GetResponse() as HttpWebResponse;\n                if (!File.Exists(DownloadPath + ".dcj"))\n                {\n                    LogTool.WriteLogDebug(typeof(HttpDownload),"\xe6\xad\xa3\xe5\x9c\xa8\xe5\x88\x9b\xe5\xbb\xba\xe6\x96\x87\xe4\xbb\xb6: "+DownloadPath+".dcj");\n                    DownloadInfo info = new DownloadInfo\n                    {\n                        ContentLength = Response.ContentLength,\n                        BlockLength = Response.ContentLength / ThreadNum,\n                        DownloadUrl = Url,\n                        Cookies=Cookies\n                    };\n                    info.init(DownloadPath + ".dcj");\n                }\n                Info = JsonConvert.DeserializeObject<DownloadInfo>(File.ReadAllText(DownloadPath + ".dcj"));\n            }\n            catch(Exception ex)\n            {\n                LogTool.WriteLogError(typeof(HttpDownload), "\xe5\x88\x9b\xe5\xbb\xba\xe6\x95\xb0\xe6\x8d\xae\xe6\x96\x87\xe4\xbb\xb6\xe5\x87\xba\xe7\x8e\xb0\xe9\x94\x99\xe8\xaf\xaf", ex);\n                MessageBox.Show("\xe5\x88\x9b\xe5\xbb\xba\xe6\x95\xb0\xe6\x8d\xae\xe6\x96\x87\xe4\xbb\xb6\xe6\x97\xb6\xe5\x87\xba\xe7\x8e\xb0\xe9\x94\x99\xe8\xaf\xaf: "+ex.Message);\n                File.Delete(DownloadPath + ".dcj");\n            }\n        }\n\n\n        int CompletedThread = 0;\n        private void HttpDownload_ThreadCompletedEvent()\n        {\n            lock (this)\n            {\n                CompletedThread++;\n                if (CompletedThread >= Threads.Length)\n                {\n                    Downloading = false;\n                    Completed = true;\n                    Speed = 0L;\n                    Percentage = 100F;\n                    Info.Completed = true;\n                    Info.Save(DownloadPath + ".dcj");\n                }\n            }\n        }\n\n        public void a()\n        {\n            long temp = 0L;\n            while (Downloading)\n            {\n                Thread.Sleep(1000);\n                if (temp == 0)\n                {\n                    temp = Info.CompletedLength;\n                }\n                else\n                {\n                    Speed = Info.CompletedLength - temp;\n                    Percentage = (((float)Info.CompletedLength / (float)Info.ContentLength) * 100);\n                    temp = Info.CompletedLength;\n                    //Console.WriteLine("\xe9\x80\x9f\xe5\xba\xa6: " + Speed / 1024 / 1024+"MB/S\\r\\n\xe8\xbf\x9b\xe5\xba\xa6: "+((float)Info.CompletedLength/(float)Info.ContentLength)*100);\n                }\n            }\n        }\n        /// <summary>\n        /// \xe4\xbf\x9d\xe5\xad\x98\xe5\xb9\xb6\xe7\xbb\x93\xe6\x9d\x9f\n        /// </summary>\n        public void StopAndSave()\n        {\n            if (Threads != null)\n            {\n                Downloading = false;\n                Stoped = true;\n                CompletedThread = 0;\n                foreach (var Thread in Threads)\n                {\n                    Thread.Stop();\n                }\n                Info.Save(DownloadPath + ".dcj");\n            }\n        }\n    }\n}\n'