b'# week 6 - multilevel models 1\n\n# 1\n# prior predictive varying effects\n\nn <- 1e4\nsigma <- rexp(n,1) # show also with 1/10\n#sigma <- rnorm(n,1,0.1)\nabar <- rnorm(n,0,1)\naT <- rnorm(n,abar,sigma)\ndens(inv_logit(aT),xlim=c(0,1),adj=0.1,lwd=4,col=2,xlab="probability survival")\n\nmtext(concat("sigma~exponential(0.1)"))\n\n# 2\n\nlibrary(rethinking)\ndata(reedfrogs)\nd <- reedfrogs\n\ndat <- list(\n    S = d$surv,\n    D = d$density,\n    T = 1:nrow(d),\n    P = ifelse( d$pred=="no" , 0L , 1L ),\n    G = ifelse( d$size=="small" , 1L , 2L )\n)\n\ndat$P <- ifelse( d$pred=="no" , 1L , 2L )\nm2 <- ulam(\n    alist(\n        S ~ binomial( D , p ),\n        logit(p) <- a[T] + b[P,G],\n        a[T] ~ normal( 0 , sigma ),\n        matrix[P,G]:b ~ normal( 0 , 1 ),\n        #a_bar ~ normal( 0 , 1.5 ),\n        sigma ~ exponential( 1 )\n    ), data=dat , chains=4 , cores=4 , log_lik=TRUE )\n\nprecis(m2,3,pars=c("b","sigma"))\n\n# 3\n# D as effect\n\ndat$Do <- standardize(log(d$density))\nm3 <- ulam(\n    alist(\n        S ~ binomial( D , p ),\n        logit(p) <- a[T] + b[P,G] + bD[P]*Do,\n        a[T] ~ normal( 0 , sigma ),\n        matrix[P,G]:b ~ normal( 0 , 1 ),\n        bD[P] ~ normal(0,0.5),\n        sigma ~ exponential( 1 )\n    ), data=dat , chains=4 , cores=4 , log_lik=TRUE )\n\nprecis(m3,3,pars=c("b","bD","sigma"))\n\ncompare( m2 , m3 , func=PSIS )\n\n# 4\n\n\n\n# setup status quo groups\nnreps <- 20\nD <- rep( c(10,35,10,35) , times=nreps )\nDo <- rep( ( D - mean(d$density) ) / sd(d$density) , times=nreps )\nG <- rep( c(1,1,2,2) , times=nreps )\nP <- rep( rep(2,4) , times=nreps )\n\n# simulate tanks\npost <- extract.samples(m3)\naT <- replicate( length(D) , rnorm(2000,0,post$sigma) )\n\n# simulate survival status quo\np1 <- sapply( 1:length(D) , \n    function(i) \n        inv_logit( \n            aT[,i] + \n            post$b[,P[i],G[i]] + \n            post$bD[,P[i]]*Do[i] ) )\n\n# simulate survival intervention\nP <- rep( rep(1,4) , times=nreps )\np2 <- sapply( 1:length(D) , \n    function(i) \n        inv_logit( \n            aT[,i] + \n            post$b[,P[i],G[i]] + \n            post$bD[,P[i]]*Do[i] ) )\n\ndens( p1 , lwd=4 , col=4 , xlab="probability of survival" , xlim=c(0,1) )\nmtext("status quo")\n\ndens( p2 , lwd=4 , col=2 , xlab="probability of survival" , xlim=c(0,1) )\nmtext("intervention")\n\ndens( p2 - p1 , lwd=4 , col=6 , xlab="change in probability of survival" , xlim=c(-0.2,1) )\nabline(v=0,lty=3,lwd=3)\nmtext("effect of intervention")\n\n# shuffle and take difference\ns1 <- sample( 1:80 , size=80 )\ns2 <- sample( 1:80 , size=80 )\ndens( p2[,s2] - p1[,s1] , lwd=4 , col=6 , xlab="change in probability of survival" )\nabline(v=0,lty=3,lwd=3)\nmtext("effect ignoring order")\n'